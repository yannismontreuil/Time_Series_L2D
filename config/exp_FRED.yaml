# FRED DGS10 (10-Year US Treasury Yield) experiment.
# Goal: specialist AR experts over different market regimes.

plot_shift: 1
plot_target: "y"
plot_synth_preview: true

transition_log:
  enabled: false
  print: false
  precision: 4
  stride: 1
  print_wlin_blin: false
  plot: true
  plot_show: false
  plot_save: true
  plot_na: true
  online_only: true
  plot_only_ours: true
  plot_entropy: true

environment:
  data_source: etth1
  csv_path: data/FRED_DGS10.csv
  target_column: DGS10

  # Use full dataset unless overridden.
  T: null
  seed: 13
  # Fixed seed for data/expert generation (decoupled from `seed`).
  data_seed: 42

  # Experts/regimes
  num_experts: 4
  num_regimes: 4

  # Context = yield lags + time features.
  # lags: 6; time features (dayofweek, month): 4 -> total 10.
  state_dim: 10

  context_lags: [1, 5, 20, 60, 120, 250]
  include_time_features: true
  time_features: [dayofweek, month]

  normalize_context: true
  normalization_window: 2520
  normalization_eps: 1.0e-6
  normalization_mode: "zscore"

  # Expert architectures: 4 AR (trained on regime date ranges).
  expert_archs: [ar, ar, ar, ar]
  # Add mild per-expert prediction noise to avoid a single dominant expert.
  expert_pred_noise_std: [0.03, 0.03, 0.03, 0.03]


  # Specialization windows (date ranges).
  expert_train_date_ranges:
    - ["1990-01-02", "2000-12-31"]  # expert 0: high/declining 90s
    - ["2001-01-01", "2007-12-31"]  # expert 1: pre-crisis moderation
    - ["2008-01-01", "2015-12-31"]  # expert 2: crisis + ZLB
    - ["2016-01-01", "2023-12-31"]  # expert 3: normalization + hikes

  # RNN (ESN) hyperparameters
  rnn_hidden_dim: 4
  rnn_spectral_radius: 0.8
  rnn_ridge: 1.0e-3
  rnn_washout: 5
  rnn_input_scale: 0.6
  rnn_share_reservoir: false
  rnn_hidden_dims: [8, 8, 4, 14]
  rnn_spectral_radii: [0.8, 0.8, 0.6, 0.9]
  rnn_ridges: [0.001, 0.001, 0.1, 0.001]
  rnn_washouts: [5, 5, 10, 3]
  rnn_input_scales: [0.6, 0.6, 0.4, 0.8]

  analysis_window: 2520

#  unavailable_expert_idx: 0
#  unavailable_intervals:
#    - [ 1000, 3000 ]
#  arrival_expert_idx: 3
#  arrival_intervals:
#    # Expert 4 becomes available only later in the series.
#    - [ 4000, 6000 ]

routers:
  beta: 0.0
  staleness_threshold: null
  lambda_risk: -0.1

  factorized_slds:
    enabled: true
    num_regimes: 4
    shared_dim: 2
    idiosyncratic_dim: 10
    delta_max: 4000
    R_scalar: 0.01

    # Expert-specific shared loadings (B_k) to make IG differ across experts.
    # Feature order: [lag1, lag5, lag20, lag60, lag120, lag250, dow_sin, dow_cos, month_sin, month_cos]
    B_dict:
      0:
        - [0.6, 0.0]
        - [0.35, 0.0]
        - [0.15, 0.0]
        - [0.0, 0.0]
        - [0.0, 0.0]
        - [0.1, 0.0]
        - [0.0, 0.35]
        - [0.0, 0.35]
        - [0.0, 0.15]
        - [0.0, 0.0]
      1:
        - [0.0, 0.0]
        - [0.0, 0.0]
        - [0.2, 0.0]
        - [0.45, 0.0]
        - [0.45, 0.0]
        - [0.3, 0.0]
        - [0.0, 0.0]
        - [0.0, 0.0]
        - [0.0, 0.45]
        - [0.0, 0.45]
      2:
        - [0.0, 0.0]
        - [0.0, 0.0]
        - [0.5, 0.0]
        - [0.3, 0.0]
        - [0.0, 0.0]
        - [0.2, 0.0]
        - [0.0, -0.35]
        - [0.0, 0.35]
        - [0.0, 0.15]
        - [0.0, -0.15]
      3:
        - [0.5, 0.0]
        - [0.35, 0.0]
        - [0.0, 0.0]
        - [0.0, 0.0]
        - [-0.2, 0.0]
        - [-0.1, 0.0]
        - [0.0, 0.0]
        - [0.0, 0.0]
        - [0.0, 0.5]
        - [0.0, 0.2]

    A_g:
        - [[0.95, 0.0],
           [0.0, 0.95]]
        - [[0.95, 0.0],
           [0.0, 0.95]]
        - [[0.95, 0.0],
           [0.0, 0.95]]
        - [[0.95, 0.0],
           [0.0, 0.95]]
    Q_g_scales: 1.5
    A_u_scale: [0.97, 0.96, 0.95, 0.94]
    Q_u_scales: [0.02, 0.025, 0.03, 0.035]

    exploration: ["g_z"]
    exploration_diag_enabled: true
    exploration_diag_stride: 500
    exploration_diag_samples: 100
    exploration_diag_print: true

    em_enabled: true
    em_offline_full_feedback: true
    em_tk: 2000
    em_n: 15
    em_samples: 50
    em_burn_in: 5
    em_use_validation: true
    em_val_strategy: "rolling"
    em_val_fraction: 0.5
    em_val_roll_len: 500
    em_val_roll_splits: 3
    em_val_roll_stride: null
    em_val_len: null
    em_theta_lr: 0.001
    em_theta_steps: 10
    em_print_val_loss: true
    em_eps_n: 1.0e-3

    em_online_enabled: false
    em_online_window: 600
    em_online_period: 300
    em_online_n: 1
    em_online_samples: 20
    em_online_burn_in: 3
    em_online_theta_lr: 0.001
    em_online_theta_steps: 1
    em_online_eps_n: 1.0e-3
    em_online_print_val_loss: true
    em_online_start_t: null

    transition_mode: "attention"

baselines:
  l2d:
    arch: "mlp"
    learning_rate: 0.001
    hidden_dim: 8
    window_size: 1
    alpha: 1.0
    beta: null

  l2d_sw:
    arch: "rnn"
    learning_rate: 0.001
    hidden_dim: 8
    window_size: 200
    alpha: 1.0
    beta: null

  linucb:
    alpha_ucb: 5
    l2_reg: 1.0
    feedback_mode: "partial"

  neural_ucb:
    alpha_ucb: 5
    lambda_reg: 1.0
    hidden_dim: 16
    nn_learning_rate: 0.001
    feedback_mode: "partial"

analysis:
  baselines_train_from_start: true
  cost_precision: 8

  pred_target_corr:
    enabled: true
    min_points: 10
    use_fisher: true

  tri_cycle_corr:
    enabled: true
    out_dir: "out/FRED_DGS10"

  pruning:
    enabled: false
    out_dir: "out/FRED_DGS10/pruning"

horizon_planning:
  t0: 3000
  H: 50
  method: "100_monte_carlo"
  delta: 0.05
  scenario_generator:
    type: "oracle_ar1"
    ar_coef: 0.7
    use_true_regime: false
    sigma0: 1
    q_scale: 1
    noise_scale: 1
